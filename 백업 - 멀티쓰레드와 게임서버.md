# 멀티쓰레드와 게임서버
* 2003-05-21. magicpotato.

```
//---------------------------------------------------------------------------
1) 멀티 쓰레드 기반 서버에서 유연/강력하게 붙기 위한 사용자 데이터 구조
2) 모든 상황에서 사용자가 자유롭게 행동할수 있는 데이터 구조
3) 필수적인 상황 외에서 루프가 블럭되지 않는 구조
//---------------------------------------------------------------------------

::요구사항::

1) 메인 쓰레드에서 '외부 쓰레드에서 처리중이니 대기'를 쉽게 알아야 함
2) 메인 쓰레드에서 간편하게 접속해제처리(사용자 리스트 정리)가 가능해야 함
3) 외부 쓰레드에서 작업이 끝나면 간편하게 메인 쓰레드로 제어를 넘겨야 함
4) 되도록 중간 전송 과정을 거치지 않는것이 좋음
5) 배열 자료구조 사용시 위치가 변경되어도 정상작동 해야함
6) 쓰레드 작업량이 밀려서 거부되는 경우 즉시 처리하는 루틴으로 연결해야 함
7) 대부분의 상황에서 '어떤 일의 순서가 어긋나도' 정상작동 해야 함


:: 생각나는대로 나열 ::

enum LinkThread 
{ ltAccount, ltCharacter, ltExpProc, ltPartProc, ltWebRank, ltGuildProc }

열거설명 1)
'즉시처리'가 요구되지 않는 작업은 모두 쓰레드와 연관시킨다.
-> 로그온 과정 : DB엑세스하는 시간을 루프에서 멈춰있게 할수 없다
-> 캐릭터 관리 : 대화명 중복처리나, 새 캐릭터 생성시 DB엑세스를 우회
-> 경험치 계산 : 게임은 계속 하면서, 경험치는 따로 계산/적용 한다.
-> 파트 처리 : '테일즈위버'식에서는 파트가 저장/불러오기되는데
이 두가지 부분을 쓰레드로 처리한다.
-> 웹랭킹 처리 : 웹에 캐릭터 정보를 등록할때 쓰레드로 처리한다.
-> 길드 처리 : 오랜 검색이나 부하가 큰 루틴을 쓰레드로 처리한다.



부하를 균등하게 나눈다)

-> 시야 처리 : 우선 객체들의 기본정보만 전송하고, 세부정보를 나중에 전송



필수요소란?)

-> 이동, 공격, 아이템 관리
-> 그 외의 요소는 '입력되었음'을 알려주는 UI의 즉시적인 표시가 필요하다.
-> 네트웍 형편상 즉시 처리가 안되므로 클라이언트에서 비동기 처리가 필요하다.



구조)

메인 리스트와, 무효 리스트 두개를 관리한다.
LinkThread가 한개라도 걸린 사용자가 접속해제시 무효 리스트에 둔다.
무효 리스트에서 빠지기 전에는 재접속 할수 없다.

LinkThread와 관련해서 다음과 같은 상황이 발생할수 있다
- 완전 정지하고 기다리는 상황 (접속해제 가능)
-> Accouont/Character/Guild
- 한가지 작업을 대기하면서 다른일을 하는 상황
-> PartProc(접속시 한번)
-> WebRank(해제시 한번)
-> ExpProc(에너미 객체가 죽을때마다/에너미 기준)


문제)
ExpProc에서 '대상자'가 오프라인 된 경우는 메모리 참조 에러가 날수도 있나 검토
```

EOF
